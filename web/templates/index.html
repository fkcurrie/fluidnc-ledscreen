<!DOCTYPE html>
<html>
<head>
    <title>FluidNC Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #000913;
            --bg-panel: #001326;
            --accent: #00f3ff;
            --accent-glow: #00f3ff80;
            --text: #ffffff;
            --grid: #004b8a;
            --danger: #ff0033;
            --success: #00ff66;
            --warning: #ffcc00;
        }

        body {
            font-family: 'Orbitron', sans-serif;
            background: var(--bg-dark);
            background-image: 
                linear-gradient(var(--grid) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid) 1px, transparent 1px);
            background-size: 30px 30px;
            background-position: center center;
            color: var(--text);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            padding-bottom: 20px;
        }

        .container::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, transparent 0%, var(--bg-dark) 100%);
            pointer-events: none;
            z-index: -1;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .system-panel {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .system-card {
            background: rgba(0, 243, 255, 0.05);
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid var(--accent);
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .system-card:hover {
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .system-card i {
            font-size: 2em;
            color: var(--accent);
            margin-bottom: 10px;
        }

        .system-card .value {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--accent);
            text-shadow: 0 0 10px var(--accent);
        }

        .system-card .label {
            font-size: 0.8em;
            color: var(--text);
            text-transform: uppercase;
            margin-top: 5px;
        }

        .panel {
            background: var(--bg-panel);
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 0 15px var(--accent-glow);
            border: 1px solid var(--accent);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 30px var(--accent-glow);
        }

        .header {
            text-align: center;
            padding: 20px;
            background: var(--bg-panel);
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid var(--accent);
            position: relative;
            overflow: hidden;
        }

        .header h1 {
            margin: 0;
            color: var(--accent);
            font-size: 2.5em;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--accent);
        }

        .state-panel {
            text-align: center;
        }

        .state {
            font-size: 2em;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s ease;
            text-shadow: 0 0 10px currentColor;
        }

        .coordinates {
            display: grid;
            gap: 15px;
        }

        .coordinate {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border-radius: 5px;
            font-size: 1.2em;
            transition: all 0.3s ease;
            border: 1px solid currentColor;
        }

        .coordinate i {
            font-size: 1.5em;
            width: 30px;
        }

        .coordinate-value {
            font-weight: bold;
            font-size: 1.2em;
            text-shadow: 0 0 10px currentColor;
        }

        .x-pos { color: var(--danger); box-shadow: 0 0 10px rgba(255, 0, 51, 0.3); }
        .y-pos { color: var(--success); box-shadow: 0 0 10px rgba(0, 255, 102, 0.3); }
        .z-pos { color: var(--accent); box-shadow: 0 0 10px rgba(0, 243, 255, 0.3); }

        .status-running { color: var(--success); border: 1px solid var(--success); }
        .status-idle { color: var(--warning); border: 1px solid var(--warning); }
        .status-alarm { color: var(--danger); border: 1px solid var(--danger); }
        .status-hold { color: var(--warning); border: 1px solid var(--warning); }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-card {
            background: rgba(0, 243, 255, 0.05);
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid var(--accent);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--accent);
            text-shadow: 0 0 10px var(--accent);
        }

        .stat-label {
            font-size: 0.8em;
            color: var(--text);
            text-transform: uppercase;
            margin-top: 5px;
        }

        #local-time {
            text-align: right;
            color: var(--accent);
            font-size: 1.2em;
            text-shadow: 0 0 10px var(--accent);
            align-self: center;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        .blink {
            animation: blink 0.5s ease-in-out;
        }

        .led-matrix {
            background: #000;
            border: 2px solid var(--accent);
            padding: 10px;
            border-radius: 5px;
            display: grid;
            grid-template-columns: repeat(64, 1fr);
            gap: 1px;
            width: 640px;  /* 10px per LED */
            margin: 0 auto 20px;
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .led {
            background: #111;
            border-radius: 50%;
            position: relative;
            transition: background-color 0.2s;
        }

        .led.on-blue { background: #0000ff; }
        .led.on-red { background: #ff0000; }
        .led.on-green { background: #00ff00; }
        .led.on-white { background: #ffffff; }

        .led-text {
            position: absolute;
            color: currentColor;
            font-family: monospace;
            font-size: 14px;
            text-shadow: 0 0 5px currentColor;
            white-space: nowrap;
        }

        .virtual-display {
            position: relative;
            width: 960px;
            height: 480px;
            background: #000;
            margin: 20px auto;
            border: 2px solid var(--accent);
            border-radius: 5px;
            box-shadow: 0 0 20px var(--accent-glow);
            display: grid;
            grid-template-columns: repeat(64, 1fr);
            grid-template-rows: repeat(32, 1fr);
            gap: 1px;
            padding: 2px;
        }

        .led-text {
            position: absolute;
            color: currentColor;
            font-family: monospace;
            font-size: 16px;
            text-shadow: 0 0 5px currentColor;
            white-space: nowrap;
            z-index: 10;
        }

        .system-info {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .system-info-card {
            background: rgba(0, 243, 255, 0.05);
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid var(--accent);
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .system-info-card:hover {
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .system-info-card i {
            font-size: 2em;
            color: var(--accent);
            margin-bottom: 10px;
        }

        .system-info-card .value {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--accent);
            text-shadow: 0 0 10px var(--accent);
        }

        .system-info-card .label {
            font-size: 0.8em;
            color: var(--text);
            text-transform: uppercase;
            margin-top: 5px;
        }

        .system-info-details {
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--text);
        }

        .system-info-details div {
            margin: 2px 0;
        }

        .machine-info {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .machine-card {
            background: rgba(0, 243, 255, 0.05);
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid var(--accent);
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .machine-card:hover {
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .machine-card i {
            font-size: 2em;
            color: var(--accent);
            margin-bottom: 10px;
        }

        .machine-card .value {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--accent);
            text-shadow: 0 0 10px var(--accent);
        }

        .machine-card .label {
            font-size: 0.8em;
            color: var(--text);
            text-transform: uppercase;
            margin-top: 5px;
        }

        .axis-config {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .axis-card {
            background: rgba(0, 243, 255, 0.05);
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid var(--accent);
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .axis-card:hover {
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .axis-card i {
            font-size: 2em;
            color: var(--accent);
            margin-bottom: 10px;
        }

        .axis-card .value {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--accent);
            text-shadow: 0 0 10px var(--accent);
        }

        .axis-card .label {
            font-size: 0.8em;
            color: var(--text);
            text-transform: uppercase;
            margin-top: 5px;
        }

        .stepper-info {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stepper-card {
            background: rgba(0, 243, 255, 0.05);
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid var(--accent);
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .stepper-card:hover {
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .stepper-card i {
            font-size: 2em;
            color: var(--accent);
            margin-bottom: 10px;
        }

        .stepper-card .value {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--accent);
            text-shadow: 0 0 10px var(--accent);
        }

        .stepper-card .label {
            font-size: 0.8em;
            color: var(--text);
            text-transform: uppercase;
            margin-top: 5px;
        }

        .stepper-details {
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--text);
        }

        .stepper-details div {
            margin: 2px 0;
        }
    </style>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.js"></script> -->
    <script>
        // LED text rendering functions
        const LED_CHARS = {
            // Numbers (5x8)
            '0': [[1,1,1,1,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,1,1,1,1]],
            '1': [[0,0,1,0,0], [0,0,1,0,0], [0,0,1,0,0], [0,0,1,0,0], [0,0,1,0,0], [0,0,1,0,0], [0,0,1,0,0], [1,1,1,1,1]],
            '2': [[1,1,1,1,1], [0,0,0,0,1], [0,0,0,0,1], [1,1,1,1,1], [1,0,0,0,0], [1,0,0,0,0], [1,0,0,0,0], [1,1,1,1,1]],
            '3': [[1,1,1,1,1], [0,0,0,0,1], [0,0,0,0,1], [0,1,1,1,1], [0,0,0,0,1], [0,0,0,0,1], [0,0,0,0,1], [1,1,1,1,1]],
            '4': [[1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,1,1,1,1], [0,0,0,0,1], [0,0,0,0,1], [0,0,0,0,1], [0,0,0,0,1]],
            '5': [[1,1,1,1,1], [1,0,0,0,0], [1,0,0,0,0], [1,1,1,1,1], [0,0,0,0,1], [0,0,0,0,1], [0,0,0,0,1], [1,1,1,1,1]],
            '6': [[1,1,1,1,1], [1,0,0,0,0], [1,0,0,0,0], [1,1,1,1,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,1,1,1,1]],
            '7': [[1,1,1,1,1], [0,0,0,0,1], [0,0,0,1,0], [0,0,1,0,0], [0,1,0,0,0], [0,1,0,0,0], [0,1,0,0,0], [0,1,0,0,0]],
            '8': [[1,1,1,1,1], [1,0,0,0,1], [1,0,0,0,1], [1,1,1,1,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,1,1,1,1]],
            '9': [[1,1,1,1,1], [1,0,0,0,1], [1,0,0,0,1], [1,1,1,1,1], [0,0,0,0,1], [0,0,0,0,1], [0,0,0,0,1], [1,1,1,1,1]],
            
            // Symbols
            '.': [[0], [0], [0], [0], [0], [0], [0], [1]],
            '-': [[0,0,0,0,0], [0,0,0,0,0], [0,0,0,0,0], [1,1,1,1,1], [0,0,0,0,0], [0,0,0,0,0], [0,0,0,0,0], [0,0,0,0,0]],
            ':': [[0], [1], [0], [0], [0], [1], [0], [0]],
            ' ': [[0,0,0,0,0], [0,0,0,0,0], [0,0,0,0,0], [0,0,0,0,0], [0,0,0,0,0], [0,0,0,0,0], [0,0,0,0,0], [0,0,0,0,0]],

            // Letters (5x8)
            'A': [[0,1,1,1,0], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,1,1,1,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1]],
            'B': [[1,1,1,1,0], [1,0,0,0,1], [1,0,0,0,1], [1,1,1,1,0], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,1,1,1,0]],
            'C': [[0,1,1,1,1], [1,0,0,0,0], [1,0,0,0,0], [1,0,0,0,0], [1,0,0,0,0], [1,0,0,0,0], [1,0,0,0,0], [0,1,1,1,1]],
            'D': [[1,1,1,1,0], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,1,1,1,0]],
            'E': [[1,1,1,1,1], [1,0,0,0,0], [1,0,0,0,0], [1,1,1,1,0], [1,0,0,0,0], [1,0,0,0,0], [1,0,0,0,0], [1,1,1,1,1]],
            'F': [[1,1,1,1,1], [1,0,0,0,0], [1,0,0,0,0], [1,1,1,1,0], [1,0,0,0,0], [1,0,0,0,0], [1,0,0,0,0], [1,0,0,0,0]],
            'G': [[0,1,1,1,1], [1,0,0,0,0], [1,0,0,0,0], [1,0,1,1,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [0,1,1,1,1]],
            'H': [[1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,1,1,1,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1]],
            'I': [[1,1,1,1,1], [0,0,1,0,0], [0,0,1,0,0], [0,0,1,0,0], [0,0,1,0,0], [0,0,1,0,0], [0,0,1,0,0], [1,1,1,1,1]],
            'J': [[1,1,1,1,1], [0,0,1,0,0], [0,0,1,0,0], [0,0,1,0,0], [0,0,1,0,0], [1,0,1,0,0], [1,0,1,0,0], [0,1,0,0,0]],
            'K': [[1,0,0,0,1], [1,0,0,1,0], [1,0,1,0,0], [1,1,0,0,0], [1,0,1,0,0], [1,0,0,1,0], [1,0,0,0,1], [1,0,0,0,1]],
            'L': [[1,0,0,0,0], [1,0,0,0,0], [1,0,0,0,0], [1,0,0,0,0], [1,0,0,0,0], [1,0,0,0,0], [1,0,0,0,0], [1,1,1,1,1]],
            'M': [[1,0,0,0,1], [1,1,0,1,1], [1,0,1,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1]],
            'N': [[1,0,0,0,1], [1,1,0,0,1], [1,0,1,0,1], [1,0,0,1,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1]],
            'O': [[0,1,1,1,0], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [0,1,1,1,0]],
            'P': [[1,1,1,1,0], [1,0,0,0,1], [1,0,0,0,1], [1,1,1,1,0], [1,0,0,0,0], [1,0,0,0,0], [1,0,0,0,0], [1,0,0,0,0]],
            'Q': [[0,1,1,1,0], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,1,0,1], [1,0,0,1,1], [1,0,0,0,1], [0,1,1,1,1]],
            'R': [[1,1,1,1,0], [1,0,0,0,1], [1,0,0,0,1], [1,1,1,1,0], [1,0,1,0,0], [1,0,0,1,0], [1,0,0,0,1], [1,0,0,0,1]],
            'S': [[0,1,1,1,1], [1,0,0,0,0], [1,0,0,0,0], [0,1,1,1,0], [0,0,0,0,1], [0,0,0,0,1], [1,0,0,0,1], [0,1,1,1,0]],
            'T': [[1,1,1,1,1], [0,0,1,0,0], [0,0,1,0,0], [0,0,1,0,0], [0,0,1,0,0], [0,0,1,0,0], [0,0,1,0,0], [0,0,1,0,0]],
            'U': [[1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [0,1,1,1,0]],
            'V': [[1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [0,1,0,1,0], [0,1,0,1,0], [0,0,1,0,0]],
            'W': [[1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,0,0,1], [1,0,1,0,1], [1,0,1,0,1], [1,1,0,1,1], [1,0,0,0,1]],
            'X': [[1,0,0,0,1], [1,0,0,0,1], [0,1,0,1,0], [0,0,1,0,0], [0,0,1,0,0], [0,1,0,1,0], [1,0,0,0,1], [1,0,0,0,1]],
            'Y': [[1,0,0,0,1], [1,0,0,0,1], [0,1,0,1,0], [0,0,1,0,0], [0,0,1,0,0], [0,0,1,0,0], [0,0,1,0,0], [0,0,1,0,0]],
            'Z': [[1,1,1,1,1], [0,0,0,0,1], [0,0,0,1,0], [0,0,1,0,0], [0,1,0,0,0], [1,0,0,0,0], [1,0,0,0,0], [1,1,1,1,1]]
        };

        function drawText(text, startX, startY, color) {
            const display = document.querySelector('.virtual-display');
            const width = 64;
            let cursorX = startX;

            // Clear previous text in this area (8 tall, more width for 5-wide chars)
            for (let y = startY; y < startY + 8; y++) {
                for (let x = startX; x < startX + 32; x++) {
                    const led = display.children[y * width + x];
                    led.className = 'led';
                }
            }

            // Draw new text
            for (let char of text) {
                if (LED_CHARS[char]) {
                    const pattern = LED_CHARS[char];
                    for (let y = 0; y < pattern.length; y++) {
                        for (let x = 0; x < pattern[y].length; x++) {
                            if (pattern[y][x]) {
                                const led = display.children[(startY + y) * width + cursorX + x];
                                led.className = `led on-${color}`;
                            }
                        }
                    }
                    cursorX += pattern[0].length + 1;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Create LED grid
            const display = document.querySelector('.virtual-display');
            for (let i = 0; i < 2048; i++) {
                const led = document.createElement('div');
                led.className = 'led';
                display.appendChild(led);
            }

            function updateLocalTime() {
                const now = new Date();
                document.getElementById('local-time').textContent = 
                    now.toLocaleTimeString('en-US', { 
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
            }

            function updateStepperInfo(stepperInfo) {
                for (const [axis, data] of Object.entries(stepperInfo)) {
                    const card = document.getElementById(`stepper-${axis.toLowerCase()}`);
                    const details = document.getElementById(`stepper-${axis.toLowerCase()}-details`);
                    
                    if (card && details) {
                        card.querySelector('.value').textContent = `${data.rms_current}A`;
                        details.innerHTML = `
                            <div>Hold: ${data.hold_current}A</div>
                            <div>Run: ${data.run_current}A</div>
                            <div>Temp: ${data.temperature}°C</div>
                            <div>Voltage: ${data.voltage}V</div>
                        `;
                    }
                }
            }

            function updateSystemInfo(data) {
                if (data.system_info) {
                    document.getElementById('firmware-version').textContent = data.system_info.firmware_version || 'Unknown';
                    document.getElementById('build-date').textContent = data.system_info.build_date || 'Unknown';
                    document.getElementById('machine-type').textContent = data.system_info.machine_type || 'Unknown';
                    document.getElementById('build-info').textContent = data.system_info.build_info || 'Unknown';
                }
                
                if (data.stepper_info) {
                    const stepperInfo = document.getElementById('stepper-info');
                    stepperInfo.innerHTML = '';
                    
                    Object.entries(data.stepper_info).forEach(([axis, info]) => {
                        const stepperDiv = document.createElement('div');
                        stepperDiv.className = 'stepper-data';
                        stepperDiv.innerHTML = `
                            <h4>${axis} Axis</h4>
                            <p>RMS Current: ${info.rms_current}A</p>
                            <p>Hold Current: ${info.hold_current}A</p>
                            <p>Run Current: ${info.run_current}A</p>
                            <p>Temperature: ${info.temperature}°C</p>
                            <p>Voltage: ${info.voltage}V</p>
                        `;
                        stepperInfo.appendChild(stepperDiv);
                    });
                }
                
                if (data.axis_config) {
                    const axisConfig = document.getElementById('axis-config');
                    axisConfig.innerHTML = '';
                    
                    Object.entries(data.axis_config).forEach(([axis, config]) => {
                        const axisDiv = document.createElement('div');
                        axisDiv.className = 'axis-data';
                        axisDiv.innerHTML = `
                            <h4>${axis} Axis Configuration</h4>
                            <p>Steps/mm: ${config.steps_per_mm || 'N/A'}</p>
                            <p>Max Rate: ${config.max_rate || 'N/A'} mm/min</p>
                            <p>Acceleration: ${config.acceleration || 'N/A'} mm/s²</p>
                            <p>Max Travel: ${config.max_travel || 'N/A'} mm</p>
                        `;
                        axisConfig.appendChild(axisDiv);
                    });
                }
            }

            function pollState() {
                fetch('/api/state')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Received update:', data);
                        if (data.state) {
                            document.getElementById('machine-state').textContent = data.state;
                            drawText(data.state, 45, 2, 'white');
                        }
                        if (data.mpos) {
                            drawText('Z', 2, 2, 'blue');
                            drawText(`${data.mpos.z.toFixed(3)}`, 8, 2, 'blue');
                            
                            drawText('X', 2, 12, 'red');
                            drawText(`${data.mpos.x.toFixed(3)}`, 8, 12, 'red');
                            
                            drawText('Y', 2, 22, 'green');
                            drawText(`${data.mpos.y.toFixed(3)}`, 8, 22, 'green');
                        }
                        if (data.feed_rate) {
                            document.getElementById('feed-rate').textContent = `${data.feed_rate} mm/min`;
                        }
                        if (data.spindle_rpm) {
                            document.getElementById('spindle-rpm').textContent = `${data.spindle_rpm} RPM`;
                        }
                        if (data.tool_number) {
                            document.getElementById('tool-number').textContent = `T${data.tool_number}`;
                        }
                        if (data.machine_config) {
                            updateAxisConfigs(data.machine_config);
                        }
                        if (data.stepper_info) {
                            updateStepperInfo(data.stepper_info);
                        }
                        if (data.system_info) {
                            updateSystemInfo(data.system_info);
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }

            function updateAxisConfigs(config) {
                const container = document.getElementById('axis-configs');
                container.innerHTML = '';
                
                for (const [axis, data] of Object.entries(config)) {
                    const axisCard = document.createElement('div');
                    axisCard.className = 'axis-card';
                    axisCard.innerHTML = `
                        <i class="fas fa-arrows-alt"></i>
                        <div class="value">${axis.toUpperCase()}</div>
                        <div class="label">Axis Configuration</div>
                        <div style="margin-top: 10px; font-size: 0.9em;">
                            <div>${data.steps_per_mm} steps/mm</div>
                            <div>${data.max_rate} mm/min</div>
                            <div>${data.acceleration} mm/s²</div>
                            <div>${data.max_travel} mm</div>
                        </div>
                    `;
                    container.appendChild(axisCard);
                }
            }

            function updateSystemInfo() {
                log('Fetching system info...');
                fetch('/api/system-info')
                    .then(response => {
                        log('Response received:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        log('System info received:', data);
                        try {
                            document.getElementById('pi-model').textContent = data.pi_model || 'N/A';
                            document.getElementById('cpu-temp').textContent = data.cpu_temp || 'N/A';
                            document.getElementById('memory').textContent = data.memory || 'N/A';
                            document.getElementById('uptime').textContent = data.uptime || 'N/A';
                            log('System info updated successfully');
                        } catch (error) {
                            log('Error updating DOM:', error);
                            throw error;
                        }
                    })
                    .catch(error => {
                        log('Error:', error);
                        console.error('Error:', error);
                        // Update UI to show error state
                        ['pi-model', 'cpu-temp', 'memory', 'uptime'].forEach(id => {
                            const element = document.getElementById(id);
                            if (element) {
                                element.textContent = 'Error';
                                element.style.color = '#ff0033';
                            }
                        });
                    });
            }

            // Initial updates
            pollState();
            updateLocalTime();
            updateSystemInfo();
            
            // Create separate functions for position and other data
            function pollPosition() {
                fetch('/api/state')
                    .then(response => response.json())
                    .then(data => {
                        if (data.mpos) {
                            drawText('Z', 2, 2, 'blue');
                            drawText(`${data.mpos.z.toFixed(3)}`, 8, 2, 'blue');
                            
                            drawText('X', 2, 12, 'red');
                            drawText(`${data.mpos.x.toFixed(3)}`, 8, 12, 'red');
                            
                            drawText('Y', 2, 22, 'green');
                            drawText(`${data.mpos.y.toFixed(3)}`, 8, 22, 'green');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }

            function pollOtherData() {
                fetch('/api/state')
                    .then(response => response.json())
                    .then(data => {
                        if (data.state) {
                            document.getElementById('machine-state').textContent = data.state;
                            drawText(data.state, 45, 2, 'white');
                        }
                        if (data.feed_rate) {
                            document.getElementById('feed-rate').textContent = `${data.feed_rate} mm/min`;
                        }
                        if (data.spindle_rpm) {
                            document.getElementById('spindle-rpm').textContent = `${data.spindle_rpm} RPM`;
                        }
                        if (data.tool_number) {
                            document.getElementById('tool-number').textContent = `T${data.tool_number}`;
                        }
                        if (data.machine_config) {
                            updateAxisConfigs(data.machine_config);
                        }
                        if (data.stepper_info) {
                            updateStepperInfo(data.stepper_info);
                        }
                        if (data.system_info) {
                            updateSystemInfo(data.system_info);
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
            
            // Start update intervals with different frequencies
            setInterval(pollPosition, 1000);  // Position data every second
            setInterval(pollOtherData, 30000);  // Other data every 30 seconds
            setInterval(updateLocalTime, 1000);  // Clock every second
        });

        // Debug logging function
        function log(message, data) {
            console.log(`[${new Date().toISOString()}] ${message}`, data);
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FluidNC Dashboard</h1>
        </div>
        
        <div class="virtual-display">
            <!-- LED grid will be created by JavaScript -->
        </div>

        <div class="dashboard">
            <div class="system-panel">
                <div class="system-card">
                    <i class="fas fa-microchip"></i>
                    <div class="value" id="pi-model">{{ system_info.pi_model }}</div>
                    <div class="label">Pi Model</div>
                </div>
                <div class="system-card">
                    <i class="fas fa-thermometer-half"></i>
                    <div class="value" id="cpu-temp">{{ system_info.cpu_temp }}</div>
                    <div class="label">CPU Temperature</div>
                </div>
                <div class="system-card">
                    <i class="fas fa-memory"></i>
                    <div class="value" id="memory">{{ system_info.memory }}</div>
                    <div class="label">Memory Usage</div>
                </div>
                <div class="system-card">
                    <i class="fas fa-clock"></i>
                    <div class="value" id="uptime">{{ system_info.uptime }}</div>
                    <div class="label">Uptime</div>
                </div>
            </div>

            <div class="machine-info">
                <div class="machine-card">
                    <i class="fas fa-cogs"></i>
                    <div class="value" id="machine-state">Loading...</div>
                    <div class="label">Machine State</div>
                </div>
                <div class="machine-card">
                    <i class="fas fa-tachometer-alt"></i>
                    <div class="value" id="feed-rate">Loading...</div>
                    <div class="label">Feed Rate</div>
                </div>
                <div class="machine-card">
                    <i class="fas fa-spinner"></i>
                    <div class="value" id="spindle-rpm">Loading...</div>
                    <div class="label">Spindle RPM</div>
                </div>
                <div class="machine-card">
                    <i class="fas fa-wrench"></i>
                    <div class="value" id="tool-number">Loading...</div>
                    <div class="label">Tool Number</div>
                </div>
            </div>

            <div class="stepper-info">
                <div class="stepper-card">
                    <i class="fas fa-bolt"></i>
                    <div class="value" id="stepper-x">Loading...</div>
                    <div class="label">X-Axis Stepper</div>
                    <div class="stepper-details" id="stepper-x-details"></div>
                </div>
                <div class="stepper-card">
                    <i class="fas fa-bolt"></i>
                    <div class="value" id="stepper-y">Loading...</div>
                    <div class="label">Y-Axis Stepper</div>
                    <div class="stepper-details" id="stepper-y-details"></div>
                </div>
                <div class="stepper-card">
                    <i class="fas fa-bolt"></i>
                    <div class="value" id="stepper-z">Loading...</div>
                    <div class="label">Z-Axis Stepper</div>
                    <div class="stepper-details" id="stepper-z-details"></div>
                </div>
            </div>

            <div class="system-info">
                <div class="system-info-card">
                    <i class="fas fa-code-branch"></i>
                    <div class="value" id="firmware-version">Loading...</div>
                    <div class="label">Firmware Version</div>
                </div>
                <div class="system-info-card">
                    <i class="fas fa-calendar"></i>
                    <div class="value" id="build-date">Loading...</div>
                    <div class="label">Build Date</div>
                </div>
                <div class="system-info-card">
                    <i class="fas fa-info-circle"></i>
                    <div class="value" id="build-info">Loading...</div>
                    <div class="label">Build Info</div>
                </div>
                <div class="system-info-card">
                    <i class="fas fa-cube"></i>
                    <div class="value" id="machine-type">Loading...</div>
                    <div class="label">Machine Type</div>
                </div>
            </div>

            <div class="axis-config">
                <div id="axis-configs">
                    <!-- Axis configs will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</body>
</html> 